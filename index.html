<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Threat Matrix</title>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body { margin:0; }
    .threat-wrap { font-family:'Open Sans',sans-serif; font-size:14px; line-height:1.5; color:#202124; }
    .toolbar { display:flex; gap:8px; justify-content:space-between; align-items:center; padding:8px 12px; border-bottom:1px solid #eee; background:#fafafa; position:sticky; top:0; z-index:1; }
    .status { font-size:12px; color:#5f6368; }
    .btn { padding:6px 10px; border:1px solid #d0d0d0; background:#fff; border-radius:6px; cursor:pointer; font-weight:600; font-size:13px; }
    .btn:hover { background:#f3f4f4; }
    .threat-table { border-collapse: collapse; width: 100%; margin-bottom: 10px; table-layout: fixed; }
    .threat-table th:nth-child(1), .threat-table td:nth-child(1){ width:45%; }
    .threat-table th:nth-child(2), .threat-table td:nth-child(2),
    .threat-table th:nth-child(3), .threat-table td:nth-child(3){ width:27.5%; }
    .threat-table th, .threat-table td { border:1px solid #e0e0e0; padding:10px; vertical-align:middle; text-align:center; background:#fff; word-break:break-word;}
    .threat-table th { background:#e8f0fe; color:#1a73e8; font-weight:600; }
    .threat-table tbody tr:nth-child(even){ background:#fafafa; }
    .rating-high{color:#b71c1c;font-weight:600;}
    .rating-med{color:#f57c00;font-weight:600;}
    .rating-low{color:#2e7d32;font-weight:600;}
    .rating-cell{min-width:0;}
    .rating-select{width:100%;padding:6px 8px;border:1px solid #d0d0d0;border-radius:6px;background:#fff;font-weight:600;cursor:pointer;}
    .rating-none .rating-select{color:#5f6368;font-weight:400;}
    .rating-high .rating-select{color:#b71c1c;}
    .rating-med .rating-select{color:#f57c00;}
    .rating-low .rating-select{color:#2e7d32;}
    .details{text-align:left;padding:8px 20px;background:#fdfdfd;border:1px solid #e0e0e0;border-top:none;margin-bottom:15px;}
    .details .controls{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:6px;}
    .details-ol{margin:0;padding-left:20px;}
    .details-ol li{margin:5px 0;padding:6px 8px;background:#fff;border:1px dashed #e0e0e0;border-radius:6px;}
    .details-ol li[contenteditable="true"]:focus{outline:2px solid #cde2ff;border-color:#cde2ff;background:#f8fbff;}
    .delete-threat-btn{color:#b71c1c;border-color:#b71c1c;}
    .delete-threat-btn:hover{background:#ffeaea;}
    .add-threat-bar{display:flex;justify-content:flex-end;padding:10px 12px 16px 12px;}
    .frame{overflow-x:auto;border:1px solid #e0e0e0;border-radius:8px;}
  </style>
</head>
<body>
  <div class="frame">
    <div class="threat-wrap" id="threatContainer">
      <div class="toolbar">
        <div class="status" id="saveStatus">Loadingâ€¦</div>
        <div style="display:flex; gap:8px;">
          <button class="btn" id="saveNowBtn">Save Now</button>
          <button class="btn" id="reloadBtn">Reload</button>
        </div>
      </div>

      <div id="threatBlocks"></div>

      <div class="add-threat-bar">
        <button type="button" class="btn" id="addThreatBtn">+ Add Threat</button>
      </div>
    </div>
  </div>

  <template id="threatTemplate">
    <section class="threat-block">
      <table class="threat-table">
        <thead>
          <tr>
            <th>Threat</th>
            <th>GSA Risk Rating</th>
            <th>Potâ€™l Impact to Meta</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><strong contenteditable="true">New Threat</strong></td>
            <td class="rating-cell rating-none">
              <select class="rating-select">
                <option value="" selected>â€” Select â€”</option>
                <option value="high">High</option>
                <option value="med">Med</option>
                <option value="low">Low</option>
              </select>
            </td>
            <td class="rating-cell rating-none">
              <select class="rating-select">
                <option value="" selected>â€” Select â€”</option>
                <option value="high">High</option>
                <option value="med">Med</option>
                <option value="low">Low</option>
              </select>
            </td>
          </tr>
        </tbody>
      </table>
      <div class="details">
        <div class="controls">
          <button type="button" class="btn" data-action="add">Add item</button>
          <button type="button" class="btn" data-action="remove">Remove last</button>
          <button type="button" class="btn" data-action="clear">Clear all</button>
          <button type="button" class="btn delete-threat-btn" data-action="delete">ðŸ—‘ Delete Threat</button>
        </div>
        <ol class="details-ol">
          <li contenteditable="true">New itemâ€¦</li>
        </ol>
      </div>
    </section>
  </template>

  <script>
    (function(){
      const API = {
        url: 'YOUR_WEB_APP_URL', // e.g. https://script.google.com/macros/s/XXXX/exec
        token: 'YOUR_SHARED_SECRET'
      };

      const blocksHolder = document.getElementById('threatBlocks');
      const tpl = document.getElementById('threatTemplate');
      const statusEl = document.getElementById('saveStatus');

      function setStatus(t){ statusEl.textContent = t; }
      function applyRatingClass(td, v){
        td.className = td.className.replace(/\brating-(high|med|low|none)\b/g,'').trim() + ' ' + (v ? 'rating-'+v : 'rating-none');
      }
      function blockToJSON(block){
        const title = (block.querySelector('strong[contenteditable]')?.textContent || '').trim();
        const gsa = block.querySelector('td:nth-child(2) .rating-select')?.value || '';
        const impact = block.querySelector('td:nth-child(3) .rating-select')?.value || '';
        const items = Array.from(block.querySelectorAll('.details-ol li')).map(li=>li.textContent.trim()).filter(Boolean);
        return { title, gsa, impact, items };
      }
      function serializeAll(){ return { threats: Array.from(blocksHolder.querySelectorAll('.threat-block')).map(blockToJSON) }; }

      function renderThreat(th){
        const fragment = document.importNode(tpl.content, true);
        const section = fragment.querySelector('.threat-block');
        const titleEl = section.querySelector('strong[contenteditable]');
        const gsaSel = section.querySelector('td:nth-child(2) .rating-select');
        const impSel = section.querySelector('td:nth-child(3) .rating-select');

        titleEl.textContent = (th && th.title) || 'New Threat';
        if(gsaSel){ gsaSel.value = (th && th.gsa) || ''; applyRatingClass(gsaSel.closest('.rating-cell'), gsaSel.value); }
        if(impSel){ impSel.value = (th && th.impact) || ''; applyRatingClass(impSel.closest('.rating-cell'), impSel.value); }

        const list = section.querySelector('.details-ol');
        list.innerHTML = '';
        ((th && th.items) || ['New itemâ€¦']).forEach(t=>{
          const li = document.createElement('li');
          li.setAttribute('contenteditable','true');
          li.textContent = t;
          list.appendChild(li);
        });

        blocksHolder.appendChild(section);
        return section;
      }

      async function loadFromServer(){
        try{
          setStatus('Loadingâ€¦');
          const url = API.url + '?token=' + encodeURIComponent(API.token);
          const res = await fetch(url, { method:'GET' });
          if(!res.ok) throw new Error('HTTP ' + res.status);
          const data = await res.json();
          blocksHolder.innerHTML = '';
          (data?.threats || []).forEach(t => renderThreat(t));
          setStatus('Loaded.');
        }catch(err){
          console.error(err);
          setStatus('Failed to load (server).');
        }
      }

      async function saveToServer(){
        try{
          setStatus('Savingâ€¦');
          const url = API.url + '?token=' + encodeURIComponent(API.token);
          const payload = serializeAll();
          const res = await fetch(url, {
            method:'POST',
            headers:{ 'Content-Type':'application/json' },
            body: JSON.stringify(payload)
          });
          if(!res.ok){
            const txt = await res.text();
            throw new Error('HTTP ' + res.status + ' ' + txt);
          }
          setStatus('Saved.');
        }catch(err){
          console.error(err);
          setStatus('Save failed.');
        }
      }

      // UI
      document.getElementById('addThreatBtn').addEventListener('click', ()=>{
        const sec = renderThreat({ title:'New Threat', gsa:'', impact:'', items:['New itemâ€¦'] });
        sec.querySelector('strong').focus();
        scheduleSave();
      });

      document.getElementById('threatContainer').addEventListener('click', e=>{
        let btn = e.target.closest('button');
        if(!btn) return;
        const action = btn.getAttribute('data-action');
        if(!action) return;
        const block = btn.closest('.threat-block');
        const list = block.querySelector('.details-ol');

        if(action === 'add'){ const li = document.createElement('li'); li.contentEditable = true; li.textContent = 'New itemâ€¦'; list.appendChild(li); li.focus(); }
        if(action === 'remove'){ list.lastElementChild?.remove(); }
        if(action === 'clear'){ list.innerHTML = ''; }
        if(action === 'delete'){ block.remove(); }
        scheduleSave();
      });

      document.getElementById('threatContainer').addEventListener('input', e=>{
        if (e.target.matches('strong[contenteditable], .details-ol li[contenteditable]')) scheduleSave();
      });
      document.getElementById('threatContainer').addEventListener('change', e=>{
        const sel = e.target;
        if(!sel.classList || !sel.classList.contains('rating-select')) return;
        applyRatingClass(sel.closest('.rating-cell'), sel.value);
        scheduleSave();
      });

      document.getElementById('saveNowBtn').addEventListener('click', saveToServer);
      document.getElementById('reloadBtn').addEventListener('click', loadFromServer);

      // Debounced autosave
      let saveTimer = null;
      function scheduleSave(){ clearTimeout(saveTimer); saveTimer = setTimeout(saveToServer, 600); }

      // Start
      loadFromServer();
    })();
  </script>
</body>
</html>
