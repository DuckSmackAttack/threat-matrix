<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Threat Matrix</title>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body { margin:0; }
    .threat-wrap { font-family:'Open Sans',sans-serif; font-size:14px; line-height:1.5; color:#202124; }
    .toolbar { display:flex; gap:8px; justify-content:space-between; align-items:center; padding:8px 12px; border-bottom:1px solid #eee; background:#fafafa; position:sticky; top:0; z-index:1; }
    .status { font-size:12px; color:#5f6368; }
    .btn { padding:6px 10px; border:1px solid #d0d0d0; background:#fff; border-radius:6px; cursor:pointer; font-weight:600; font-size:13px; }
    .btn:hover { background:#f3f4f4; }

    .threat-table {
      border-collapse: collapse;
      width: 100%;
      margin-bottom: 10px;
      table-layout: fixed;
    }
    .threat-table th:nth-child(1), .threat-table td:nth-child(1){width:45%;}
    .threat-table th:nth-child(2), .threat-table td:nth-child(2),
    .threat-table th:nth-child(3), .threat-table td:nth-child(3){width:27.5%;}
    .threat-table th, .threat-table td {
      border: 1px solid #e0e0e0;
      padding: 10px;
      vertical-align: middle;
      text-align: center;
      background:#fff;
      word-break:break-word;
    }
    .threat-table th {background:#e8f0fe;color:#1a73e8;font-weight:600;}
    .threat-table tbody tr:nth-child(even){background:#fafafa;}

    .rating-high{color:#b71c1c;font-weight:600;}
    .rating-med{color:#f57c00;font-weight:600;}
    .rating-low{color:#2e7d32;font-weight:600;}
    .rating-cell{min-width:0;}
    .rating-select{width:100%;padding:6px 8px;border:1px solid #d0d0d0;border-radius:6px;background:#fff;font-weight:600;cursor:pointer;}
    .rating-none .rating-select{color:#5f6368;font-weight:400;}
    .rating-high .rating-select{color:#b71c1c;}
    .rating-med .rating-select{color:#f57c00;}
    .rating-low .rating-select{color:#2e7d32;}

    .details{text-align:left;padding:8px 20px;background:#fdfdfd;border:1px solid #e0e0e0;border-top:none;margin-bottom:15px;}
    .details .controls{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:6px;}
    .details-ol{margin:0;padding-left:20px;}
    .details-ol li{margin:5px 0;padding:6px 8px;background:#fff;border:1px dashed #e0e0e0;border-radius:6px;}
    .details-ol li[contenteditable="true"]:focus{outline:2px solid #cde2ff;border-color:#cde2ff;background:#f8fbff;}

    .delete-threat-btn{color:#b71c1c;border-color:#b71c1c;}
    .delete-threat-btn:hover{background:#ffeaea;}
    .add-threat-bar{display:flex;justify-content:flex-end;padding:10px 12px 16px 12px;}
    .frame{overflow-x:auto;border:1px solid #e0e0e0;border-radius:8px;}
  </style>
</head>
<body>
  <div class="frame">
    <div class="threat-wrap" id="threatContainer">
      <div class="toolbar">
        <div class="status" id="saveStatus">Ready.</div>
        <div style="display:flex; gap:8px;">
          <button class="btn" id="saveNowBtn">Save</button>
          <button class="btn" id="clearBtn">Clear</button>
        </div>
      </div>

      <div id="threatBlocks"></div>

      <div class="add-threat-bar">
        <button type="button" class="btn" id="addThreatBtn">+ Add Threat</button>
      </div>
    </div>
  </div>

  <template id="threatTemplate">
    <section class="threat-block">
      <table class="threat-table">
        <thead>
          <tr>
            <th>Threat</th>
            <th>GSA Risk Rating</th>
            <th>Potâ€™l Impact to Meta</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><strong contenteditable="true">New Threat</strong></td>
            <td class="rating-cell rating-none">
              <select class="rating-select">
                <option value="" selected>â€” Select â€”</option>
                <option value="high">High</option>
                <option value="med">Med</option>
                <option value="low">Low</option>
              </select>
            </td>
            <td class="rating-cell rating-none">
              <select class="rating-select">
                <option value="" selected>â€” Select â€”</option>
                <option value="high">High</option>
                <option value="med">Med</option>
                <option value="low">Low</option>
              </select>
            </td>
          </tr>
        </tbody>
      </table>
      <div class="details">
        <div class="controls">
          <button type="button" class="btn" data-action="add">Add item</button>
          <button type="button" class="btn" data-action="remove">Remove last</button>
          <button type="button" class="btn" data-action="clear">Clear all</button>
          <button type="button" class="btn delete-threat-btn" data-action="delete">ðŸ—‘ Delete Threat</button>
        </div>
        <ol class="details-ol">
          <li contenteditable="true">New itemâ€¦</li>
        </ol>
      </div>
    </section>
  </template>

  <script>
    (function(){
      const STORAGE_KEY='ThreatMatrix_v1';
      const blocksHolder=document.getElementById('threatBlocks');
      const tpl=document.getElementById('threatTemplate');
      const statusEl=document.getElementById('saveStatus');

      function setStatus(t){statusEl.textContent=t;}
      function applyRatingClass(td,v){td.className=td.className.replace(/\brating-(high|med|low|none)\b/g,'').trim()+' '+(v?'rating-'+v:'rating-none');}
      function blockToJSON(b){
        const title=(b.querySelector('strong[contenteditable]')?.textContent||'').trim();
        const gsa=b.querySelector('td:nth-child(2) .rating-select')?.value||'';
        const impact=b.querySelector('td:nth-child(3) .rating-select')?.value||'';
        const items=[...b.querySelectorAll('.details-ol li')].map(li=>li.textContent.trim()).filter(Boolean);
        return{title,gsa,impact,items};
      }
      function serializeAll(){return{threats:[...blocksHolder.querySelectorAll('.threat-block')].map(blockToJSON)};}
      function renderThreat(th){
        const f=document.importNode(tpl.content,true);
        const s=f.querySelector('.threat-block');
        const title=s.querySelector('strong[contenteditable]');
        const gsaSel=s.querySelector('td:nth-child(2) .rating-select');
        const impSel=s.querySelector('td:nth-child(3) .rating-select');
        title.textContent=(th&&th.title)||'New Threat';
        if(gsaSel){gsaSel.value=(th&&th.gsa)||'';applyRatingClass(gsaSel.closest('.rating-cell'),gsaSel.value);}
        if(impSel){impSel.value=(th&&th.impact)||'';applyRatingClass(impSel.closest('.rating-cell'),impSel.value);}
        const list=s.querySelector('.details-ol');
        list.innerHTML='';
        ((th&&th.items)||['New itemâ€¦']).forEach(t=>{
          const li=document.createElement('li');li.setAttribute('contenteditable','true');li.textContent=t;list.appendChild(li);
        });
        blocksHolder.appendChild(s);
        return s;
      }

      function saveNow(){
        const data=serializeAll();
        localStorage.setItem(STORAGE_KEY,JSON.stringify(data));
        setStatus('Saved '+new Date().toLocaleTimeString());
      }
      function loadData(){
        const raw=localStorage.getItem(STORAGE_KEY);
        if(!raw)return;
        try{
          const d=JSON.parse(raw);
          if(d&&Array.isArray(d.threats)){
            blocksHolder.innerHTML='';
            d.threats.forEach(t=>renderThreat(t));
          }
          setStatus('Loaded.');
        }catch(e){console.error(e);}
      }

      document.getElementById('addThreatBtn').addEventListener('click',()=>{
        const s=renderThreat({title:'New Threat',gsa:'',impact:'',items:['New itemâ€¦']});
        s.querySelector('strong').focus(); scheduleSave();
      });
      document.getElementById('threatContainer').addEventListener('click',e=>{
        const btn=e.target.closest('button'); if(!btn)return;
        const act=btn.dataset.action; if(!act)return;
        const b=btn.closest('.threat-block'); const list=b.querySelector('.details-ol');
        if(act==='add'){const li=document.createElement('li');li.contentEditable=true;li.textContent='New itemâ€¦';list.appendChild(li);li.focus();}
        if(act==='remove'){list.lastElementChild?.remove();}
        if(act==='clear'){list.innerHTML='';}
        if(act==='delete'){b.remove();}
        scheduleSave();
      });
      document.getElementById('threatContainer').addEventListener('input',e=>{
        if(e.target.matches('strong[contenteditable], .details-ol li[contenteditable]'))scheduleSave();
      });
      document.getElementById('threatContainer').addEventListener('change',e=>{
        const sel=e.target; if(!sel.classList.contains('rating-select'))return;
        applyRatingClass(sel.closest('.rating-cell'),sel.value); scheduleSave();
      });
      document.getElementById('saveNowBtn').addEventListener('click',saveNow);
      document.getElementById('clearBtn').addEventListener('click',()=>{
        if(confirm('Clear all threats?')){blocksHolder.innerHTML='';localStorage.removeItem(STORAGE_KEY);setStatus('Cleared.');}
      });
      let t; function scheduleSave(){clearTimeout(t);t=setTimeout(saveNow,600);}
      loadData();
    })();
  </script>
</body>
</html>
